# Lab 11

## Task 1

### Creation of secret, verifying and decoding

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl create secret generic devops-secret --from-literal=username=rostislav --from-literal=password=nodroppls
secret/devops-secret created
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get secrets
NAME                               TYPE                 DATA   AGE
devops-secret                      Opaque               2      15s
sh.helm.release.v1.helm-app.v1     helm.sh/release.v1   1      7d1h
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      7d
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl describe secret devops-secret
Name:         devops-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  9 bytes
username:  9 bytes
```

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get secret devops-secret -o jsonpath='{.data}'
{"password":"bm9kcm9wcGxz","username":"cm9zdGlzbGF2"}rostislav@rostislavpc:~/devops_labs/k8s$ echo "bm9kcm9wcGxz" | base64 --decode
nodroppls
rostislav@rostislavpc:~/devops_labs/k8s$ echo "cm9zdGlzbGF2" | base64 --decode
rostislav
```

### Helm part

I installed all as in tutorial and got error but fix also was in guide so no problems at all

```
rostislav@rostislavpc:~/devops_labs/k8s$ sops -p 975EDA5774C8028A8F8CD5BBDFBC5ADA6BF239F1 secrets.yaml
Failed to get the data key required to decrypt the SOPS file.

Group 0: FAILED
  09F81EE623F8A0BE9F12FB740C95D474FB6D5E28: FAILED
    - | could not decrypt data key with PGP key:
      | github.com/ProtonMail/go-crypto/openpgp error: could not
      | load secring: open /home/rostislav/.gnupg/pubring.gpg: no
      | such file or directory; GnuPG binary error: failed to
      | decrypt sops data key with pgp: gpg: encrypted with 3072-bit
      | RSA key, ID 5FA48311FEA79463, created 2024-04-16
      |       "Rostislav <zhukov-02@yandex.ru>"
      | gpg: public key decryption failed: Inappropriate ioctl for
      | device
      | gpg: decryption failed: No secret key

Recovery failed because no master key was able to decrypt the file. In
order for SOPS to recover the file, at least one key has to be successful,
but none were.
rostislav@rostislavpc:~/devops_labs/k8s$ GPG_TTY=$(tty)
rostislav@rostislavpc:~/devops_labs/k8s$ export GPG_TTY
```

```
rostislav@rostislavpc:~/devops_labs/k8s$ helm secrets decrypt secrets.yaml
password: devopslab11
```

```
rostislav@rostislavpc:~/devops_labs/k8s$ helm secrets install helm-app ./helm-app/ -n default -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: helm-app
LAST DEPLOYED: Tue Apr 16 21:19:25 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=helm-app,app.kubernetes.io/instance=helm-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

[helm-secrets] Removed: ./secrets.yaml.dec
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get pods,svc
NAME                                           READY   STATUS    RESTARTS        AGE
pod/flask-server-deployment-68959b4dfb-6r845   1/1     Running   4 (9m57s ago)   14d
pod/flask-server-deployment-68959b4dfb-85c8w   1/1     Running   4 (9m57s ago)   14d
pod/flask-server-deployment-68959b4dfb-gmpmc   1/1     Running   4 (9m57s ago)   14d
pod/helm-app-68746b5959-g7fmz                  1/1     Running   0               34s

NAME                           TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/flask-server-service   LoadBalancer   10.109.75.119   <pending>     5000:30444/TCP   14d
service/helm-app               ClusterIP      10.102.134.75   <none>        80/TCP           34s
service/kubernetes             ClusterIP      10.96.0.1       <none>        443/TCP          14d
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get secret credentials -o yaml
apiVersion: v1
data:
  password: ZGV2b3BzbGFiMTE=
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: helm-app
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2024-04-16T18:19:42Z"
  labels:
    app: helm-app
    app.kubernetes.io/managed-by: Helm
    chart: helm-app-0.1.0
    heritage: Helm
    release: helm-app
  name: credentials
  namespace: default
  resourceVersion: "11451"
  uid: 364aad6d-1903-43cc-8bcd-141e6e12f95d
type: Opaque
rostislav@rostislavpc:~/devops_labs/k8s$ echo "ZGV2b3BzbGFiMTE=" | base64 --decode
devopslab11
```

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl exec helm-app-68746b5959-g7fmz -- printenv | grep DEVOPS_STUDENT
DEVOPS_STUDENT=devopslab11
```

## Task 2

I got this without VPN:

```
helm repo add hashicorp https://helm.releases.hashicorp.com
Error: looks like "https://helm.releases.hashicorp.com" is not a valid chart repository or cannot be reached: failed to fetch https://helm.releases.hashicorp.com/index.yaml : 403 Forbidden
```

And this with VPN:

```
helm repo add hashicorp https://helm.releases.hashicorp.com
Error: looks like "https://helm.releases.hashicorp.com" is not a valid chart repository or cannot be reached: Get "https://helm.releases.hashicorp.com/index.yaml": dial tcp: lookup helm.releases.hashicorp.com on 172.19.0.1:53: read udp 172.19.1.71:53692->172.19.0.1:53: i/o timeout
```

Maybe problem with my VPN, but I just gave up and decided to do a task for bonus points instead of Task 2

## Bonus task

Limits and requests working

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl describe pod helm-app-68746b5959-g7fmz
Name:             helm-app-68746b5959-g7fmz
Namespace:        default
Priority:         0
Service Account:  helm-app
Node:             minikube/192.168.49.2
Start Time:       Tue, 16 Apr 2024 21:19:42 +0300
Labels:           app.kubernetes.io/instance=helm-app
                  app.kubernetes.io/name=helm-app
                  pod-template-hash=68746b5959
Annotations:      <none>
Status:           Running
IP:               10.244.0.41
IPs:
  IP:           10.244.0.41
Controlled By:  ReplicaSet/helm-app-68746b5959
Containers:
  helm-app:
    Container ID:   docker://e3ff83a29fd69f9e3e3b97439fdae6ba149ca6107265112483ba1236ff94156d
    Image:          hallejujah/devops_app:latest
    Image ID:       docker-pullable://hallejujah/devops_app@sha256:245da29974eba74fc270d3e7915e3933c18715bdcd2e76b72ff062059a9f38b6
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 16 Apr 2024 21:19:43 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:      250m
      memory:   64Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      DEVOPS_STUDENT:  <set to the key 'password' in secret 'credentials'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-68rhm (ro)
...
```

