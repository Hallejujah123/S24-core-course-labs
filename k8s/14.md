# Lab 14

## Kubernetes Cluster Monitoring with Prometheus
Install with

```
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install promkube prometheus-community/kube-prometheus-stack
```

```
rostislav@rostislavpc:~$ helm install promkube prometheus-community/kube-prometheus-stack
NAME: promkube
LAST DEPLOYED: Tue May  7 20:34:49 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
kube-prometheus-stack has been installed. Check its status by running:
  kubectl --namespace default get pods -l "release=promkube"

Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create & configure Alertmanager and Prometheus instances using the Operator.
```

** My app + installed charts: **

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS    RESTARTS   AGE
pod/alertmanager-promkube-kube-prometheus-s-alertmanager-0   2/2     Running   2          4h5m
pod/prometheus-promkube-kube-prometheus-s-prometheus-0       2/2     Running   2          4h5m
pod/promkube-grafana-77d8ff9d9b-8xxpf                        3/3     Running   3          4h5m
pod/promkube-kube-prometheus-s-operator-7dd945d546-n4rpg     1/1     Running   1          4h5m
pod/promkube-kube-state-metrics-569bf55cd6-vcqzz             1/1     Running   1          4h5m
pod/promkube-prometheus-node-exporter-5krrz                  1/1     Running   1          4h5m
pod/stateful-helm-app-0                                      1/1     Running   2          7d1h
pod/stateful-helm-app-1                                      1/1     Running   2          7d1h

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-promkube-kube-prometheus-s-alertmanager   1/1     4h5m
statefulset.apps/prometheus-promkube-kube-prometheus-s-prometheus       1/1     4h5m
statefulset.apps/stateful-helm-app                                      2/2     7d1h

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)
     AGE
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   4h5m
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP
     7d2h
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP
     4h5m
service/promkube-grafana                          ClusterIP      10.106.46.73     <none>        80/TCP
     4h5m
service/promkube-kube-prometheus-s-alertmanager   ClusterIP      10.102.178.69    <none>        9093/TCP,8080/TCP            4h5m
service/promkube-kube-prometheus-s-operator       ClusterIP      10.96.211.253    <none>        443/TCP
     4h5m
service/promkube-kube-prometheus-s-prometheus     ClusterIP      10.109.172.208   <none>        9090/TCP,8080/TCP            4h5m
service/promkube-kube-state-metrics               ClusterIP      10.104.196.181   <none>        8080/TCP
     4h5m
service/promkube-prometheus-node-exporter         ClusterIP      10.106.205.218   <none>        9100/TCP
     4h5m
service/stateful-helm-app                         LoadBalancer   10.101.136.254   <pending>     80:31111/TCP
     7d1h

NAME                                                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/persistent-volumemount-stateful-helm-app-0   Bound    pvc-f1ba7778-b0fd-4685-81c3-e4fb8957aac9   128Mi      RWO            standard       7d2h
persistentvolumeclaim/persistent-volumemount-stateful-helm-app-1   Bound    pvc-ece2ab7f-65b3-4f3a-ad55-b400b189ba44   128Mi      RWO            standard       7d2h

NAME                                                                     DATA   AGE
configmap/devops-map                                                     1      7d1h
configmap/kube-root-ca.crt                                               1      7d2h
configmap/prometheus-promkube-kube-prometheus-s-prometheus-rulefiles-0   35     4h5m
configmap/promkube-grafana                                               1      4h5m
configmap/promkube-grafana-config-dashboards                             1      4h5m
configmap/promkube-kube-prometheus-s-alertmanager-overview               1      4h5m
configmap/promkube-kube-prometheus-s-apiserver                           1      4h5m
configmap/promkube-kube-prometheus-s-cluster-total                       1      4h5m
configmap/promkube-kube-prometheus-s-controller-manager                  1      4h5m
configmap/promkube-kube-prometheus-s-etcd                                1      4h5m
configmap/promkube-kube-prometheus-s-grafana-datasource                  1      4h5m
configmap/promkube-kube-prometheus-s-grafana-overview                    1      4h5m
configmap/promkube-kube-prometheus-s-k8s-coredns                         1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-cluster               1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-multicluster          1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-namespace             1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-node                  1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-pod                   1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-workload              1      4h5m
configmap/promkube-kube-prometheus-s-k8s-resources-workloads-namespace   1      4h5m
configmap/promkube-kube-prometheus-s-kubelet                             1      4h5m
configmap/promkube-kube-prometheus-s-namespace-by-pod                    1      4h5m
configmap/promkube-kube-prometheus-s-namespace-by-workload               1      4h5m
configmap/promkube-kube-prometheus-s-node-cluster-rsrc-use               1      4h5m
configmap/promkube-kube-prometheus-s-node-rsrc-use                       1      4h5m
configmap/promkube-kube-prometheus-s-nodes                               1      4h5m
configmap/promkube-kube-prometheus-s-nodes-darwin                        1      4h5m
configmap/promkube-kube-prometheus-s-persistentvolumesusage              1      4h5m
configmap/promkube-kube-prometheus-s-pod-total                           1      4h5m
configmap/promkube-kube-prometheus-s-prometheus                          1      4h5m
configmap/promkube-kube-prometheus-s-proxy                               1      4h5m
configmap/promkube-kube-prometheus-s-scheduler                           1      4h5m
configmap/promkube-kube-prometheus-s-workload-total                      1      4h5m
```

This command lists:
    `po` - short for pods
    `sts`- short for StatefulSets
    `svc` - short for services
    `pvc` - short for PersistentVolumeClaim
    `cm` - short for configmap
in current namespace

`helm show values prometheus-community/kube-prometheus-stack | grep  adminPassword` will show passsword for `admin`.

```
rostislav@rostislavpc:~/devops_labs/k8s$ helm show values prometheus-community/kube-prometheus-stack | grep  adminPassword
  adminPassword: prom-operator
```

## Answering questions

1) 
CPU:
![](/k8s/screenshots/CPU.jpg)
Memory:
![](/k8s/screenshots/Memory.jpg)

2) My app consumes most memory and CPU.
Alert manager is the smallest memory consumer.

3) ![](/k8s/screenshots/Nodes.jpg)

4) ![](/k8s/screenshots/Kubelet.jpg)

5) ![](/k8s/screenshots/Network.jpg)

6) I used Web interface, Alert manager dashboard
![](/k8s/screenshots/Alerts.jpg)

## Init

Copied content of the dile from tutorial to my folder, initialized it with `kubectl apply -f container/container.yaml`

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl get pod init-demo
NAME        READY   STATUS     RESTARTS   AGE
init-demo   0/1     Init:0/1   0          15s
```

![](/k8s/screenshots/demo1.jpg)

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl exec -it init-demo -- /bin/bash
Defaulted container "nginx" out of: nginx, install (init)
root@init-demo:/# apt-get install wget
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
E: Unable to locate package wget
root@init-demo:/# apt-get update
Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8786 kB]
Get:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [13.8 kB]
Get:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [157 kB]
Fetched 9212 kB in 2s (5479 kB/s)
Reading package lists... Done
root@init-demo:/# apt-get install wget
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following NEW packages will be installed:
  wget
0 upgraded, 1 newly installed, 0 to remove and 2 not upgraded.
Need to get 984 kB of archives.
After this operation, 3692 kB of additional disk space will be used.
Get:1 http://deb.debian.org/debian bookworm/main amd64 wget amd64 1.21.3-1+b2 [984 kB]
Fetched 984 kB in 0s (3069 kB/s)
debconf: delaying package configuration, since apt-utils is not installed
Selecting previously unselected package wget.
(Reading database ... 7582 files and directories currently installed.)
Preparing to unpack .../wget_1.21.3-1+b2_amd64.deb ...
Unpacking wget (1.21.3-1+b2) ...
Setting up wget (1.21.3-1+b2) ...
root@init-demo:/# wget http://info.cern.ch
--2024-05-07 21:45:36--  http://info.cern.ch/
Resolving info.cern.ch (info.cern.ch)... 188.184.100.182, 2001:1458:d00:35::100:222
Connecting to info.cern.ch (info.cern.ch)|188.184.100.182|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 646 [text/html]
Saving to: 'index.html'

index.html                    100%[=================================================>]     646  --.-KB/s    in 0s

2024-05-07 21:45:36 (93.5 MB/s) - 'index.html' saved [646/646]

root@init-demo:/# ls
bin   dev                  docker-entrypoint.sh  home        lib    media  opt   root  sbin  sys  usr
boot  docker-entrypoint.d  etc                   index.html  lib64  mnt    proc  run   srv   tmp  var
root@init-demo:/#
```

![](/k8s/screenshots/demo2.jpg)

```
rostislav@rostislavpc:~/devops_labs/k8s$ kubectl exec -it init-demo -- cat /index.html
Defaulted container "nginx" out of: nginx, install (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```